# クラウド移行 & マルチテナント構想

## 作成日: 2026年1月3日

---

## 0. プロジェクト概要

### このプロジェクトの目標
**現在の豊満倶楽部HPを「参考」に、新しいマルチテナントWebアプリケーションをAWSにゼロから構築する。**

### 対象店舗
| 店舗名 | ドメイン | 備考 |
|--------|---------|------|
| 豊満倶楽部 | club-houman.com | デリバリーヘルス（メイン） |
| 人妻の楽園 | - | 同系列店舗 |

### 現在のサーバー環境
| 項目 | 内容 |
|------|------|
| サーバー | Xserver（共有サーバー） |
| ドメイン | club-houman.com |
| デプロイ | GitHub + git-ftp |
| DB | 2つ（houman / rakuen） |
| PHPファイル数 | 268個 |
| 総ファイル数 | 1,428個 |

### 構築アプローチ（重要）

**❌ 従来の移行アプローチ（これではない）**
```
現在の豊満倶楽部コード → マルチテナント化改修 → AWS移行
```

**✅ 新規構築アプローチ（採用）**
```
【Step 1】新しいマルチテナントWebアプリをAWSにゼロから構築
          （現在の豊満倶楽部を「参考」にする）
              ↓
【Step 2】スーパー管理画面から「豊満倶楽部」アカウントを作成
              ↓
【Step 3】豊満倶楽部用の店舗管理画面でデザイン・機能を設定
              ↓
【Step 4】club-houman.comのDNSを切り替えて公開
```

### この方法のメリット
| メリット | 説明 |
|---------|------|
| 技術的負債なし | 現在のコードの問題点を引き継がない |
| 最初からマルチテナント設計 | 後から改修するより効率的 |
| きれいなコード | 新規構築なので設計がスッキリ |
| テスト環境で完成させられる | 本番に影響なし |
| 他店舗展開が簡単 | 同じ仕組みで新店舗を追加 |

### 決定事項 ✅
- [x] AWS Lightsailから始める
- [x] プラットフォームドメインを取得してテスト環境構築
- [x] マルチテナント + Docker化を目指す
- [x] 新規構築アプローチを採用（現在のコードを移行するのではなく、参考にして新規構築）
- [x] スーパー管理画面から店舗を作成する方式
- [x] **サービス名: pullcass（プルキャス）** ← 決定！
- [x] **ドメイン: pullcass.com** ← 取得可能確認済み
- [x] **DB設計: 共有DB + tenant_id 方式** ← 2026/1/13決定

### 検討中 🔄
- [ ] 社名（運営会社名）
- [ ] SaaS化の料金体系
- [ ] 具体的な開発スケジュール

### 更新履歴
| 日付 | 内容 |
|------|------|
| 2026/1/3 | 初版作成。クラウド移行の基本構想 |
| 2026/1/3 | SEO観点、スーパー管理画面、SaaS化について追記 |
| 2026/1/3 | メール送信現状、GAS連携、プラットフォームドメイン構想追記 |
| 2026/1/3 | 「新規構築アプローチ」を明確化。概要セクション追加 |
| 2026/1/4 | **サービス名決定: pullcass（プルキャス）** ドメイン: pullcass.com |
| 2026/1/13 | **DB設計決定: 共有DB + tenant_id方式**（500店舗目標に対応） |

---

## 1. 背景・目的

### きっかけ
- 以前、プログラムが壊れてサーバーバックアップから復旧した際、DBも1日前に戻りデータが失われた経験がある
- DBを別のDBにバックアップしておけば、復旧時にDBだけ差し替えられる

### 移行の目的
- **コスト削減**
- **パフォーマンス向上**
- **セキュリティ面の心配**（現在は共有サーバー）

---

## 2. DBバックアップの選択肢

### 2つのDBに同時格納する方法
| 方法 | 説明 | メリット | デメリット |
|------|------|---------|-----------|
| アプリ層での二重書き込み | PHPコード内で2つのPDO接続に書き込む | シンプル | 処理時間が倍、103ファイルに影響 |
| MySQLトリガー | DB側で自動的にバックアップテーブルにコピー | コード変更不要 | 同一サーバー内のみ |
| 定期同期スクリプト | cronで定期的にメインDBからバックアップDBにコピー | 処理に影響なし | 同期間隔分のデータロス |

### DBに書き込みを行っているファイル
- **103ファイル**でDB書き込みが行われている

---

## 3. クラウドサーバーの比較

### 現在の豊満倶楽部の規模
- PHPファイル: **268個**
- 総ファイル数: **1,428個**
- データベース: **2つ**（houman / rakuen）
- 主な機能: スクレイピング、管理画面、メンバー機能、LINE連携

### おすすめ: AWS Lightsail $5プラン
| 理由 | 詳細 |
|------|------|
| コスト | 月額 **$5（約750円）** で十分 |
| パフォーマンス | 共有サーバーより確実に速い |
| シンプル | AWS の中で最も設定が簡単 |
| 東京リージョン | あり（低レイテンシ） |
| 将来の拡張 | AWS本体への移行も簡単 |

#### $5プランのスペック
- vCPU: 1
- メモリ: 1GB
- SSD: 40GB
- 転送量: 2TB/月

### その他の選択肢
| サービス | 月額目安 | 特徴 |
|---------|---------|------|
| GCP Compute Engine | 約750円〜 | 高性能、無料枠あり |
| ConoHa VPS | 500円〜 | 日本語サポート充実 |
| Xserver VPS | 830円〜 | 移行しやすい |

---

## 4. 100サイト規模への展開

### 段階的な成長プラン
```
現在（1〜2サイト）
  AWS Lightsail $5〜10/月
      ↓
10サイト規模
  EC2 + RDS 約$100〜150/月
      ↓
50〜100サイト規模
  Kubernetes (GKE/EKS) 約$450〜620/月
```

### 100サイト運用の推奨構成: Kubernetes
| 項目 | AWS (EKS) | GCP (GKE) |
|------|-----------|-----------|
| クラスター管理 | $72/月 | 無料（Autopilot） |
| ノード | 約$300/月 | 約$250/月 |
| データベース | 約$200/月 | 約$150/月 |
| ロードバランサー等 | 約$50/月 | 約$50/月 |
| **合計** | **約$620/月（約9万円）** | **約$450/月（約7万円）** |

---

## 5. Docker & Kubernetes の基礎

### Docker とは
- サイトを「箱（コンテナ）」に入れて持ち運べるようにする技術
- どのサーバーでも同じように動く
- 新サイト立ち上げが数分で完了

### Kubernetes とは
- たくさんのDockerコンテナを自動で管理してくれるシステム
- 略称: K8s（ケーエイツ）

#### Kubernetesの機能
| 機能 | 説明 |
|------|------|
| 自動復旧 | サイトが落ちたら自動で再起動 |
| 自動スケール | アクセス増加で自動拡張 |
| 負荷分散 | アクセスを複数サーバーに分散 |
| 簡単デプロイ | 新サイト追加がコマンド1つ |
| 一元管理 | 100サイトを1画面で管理 |

---

## 6. マルチテナント + Docker 構想（最終目標）

### 仕組み
```
┌─────────────────────────────────────────────────────┐
│              1つのDockerコンテナ                    │
│  ┌─────────────────────────────────────────────┐   │
│  │            共通コード（PHP）                │   │
│  │                                             │   │
│  │  アクセスURL を判定して店舗を切り替え       │   │
│  │                                             │   │
│  │  club-houman.com → 豊満倶楽部              │   │
│  │  rakuen-site.com → 人妻の楽園              │   │
│  │  new-shop.com    → 新店舗                  │   │
│  └─────────────────────────────────────────────┘   │
│                        ↓                           │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │ DB: 豊満 │ │ DB: 楽園 │ │ DB: 新店 │           │
│  └──────────┘ └──────────┘ └──────────┘           │
└─────────────────────────────────────────────────────┘
```

### メリット
| メリット | 説明 |
|---------|------|
| 管理が楽 | コード修正が1箇所で全店舗に反映 |
| コスト削減 | サーバー1台で複数店舗運用可能 |
| 新店舗追加が簡単 | DB作成 + 設定追加だけ |
| 一元管理 | 全店舗を1つの管理画面で |

### 新店舗追加の手順（マルチテナント化後）
```
1. 新しいDB作成（5分）
2. tenants.php に設定追加（1分）
3. ドメイン設定（10分）
4. 完了！
```
**従来: 数日 → マルチテナント: 30分以内**

---

## 7. 実装ロードマップ

### 【技術基盤】

#### Phase 1: 設定の外部化（1〜2週間）
- DB接続情報を環境変数化
- 店舗名・色などを設定ファイル化
- ハードコードされた部分を洗い出し

#### Phase 1.5: テナント設定テーブル設計
- スーパー管理画面用のDB設計
- テナント情報を格納するテーブル作成

#### Phase 2: テナント切り替え機能（1〜2週間）
- ドメインで店舗を判定する仕組み
- テナントごとの設定読み込み
- 管理画面のテナント対応

#### Phase 2.5: スーパー管理画面（基本版）
- 新店舗の追加/削除機能
- 基本設定の管理機能

#### Phase 3: Docker化（1週間）
- Dockerfile作成
- docker-compose.yml作成
- ローカルでテスト

#### Phase 4: 本番デプロイ
- AWS Lightsail にDockerデプロイ
- ドメイン設定
- 運用開始

#### Phase 5: スーパー管理画面（完全版）
- 全機能実装
- 店舗追加の完全自動化

### 【ビジネス基盤】（SaaS化に必要）

#### Phase 6: 課金システム
- Stripe等の決済サービス導入
- 月額課金の仕組み

#### Phase 7: 利用規約・契約書
- 法的な整備
- SLA（サービスレベル契約）

#### Phase 8: サポート体制
- 問い合わせ対応の仕組み
- マニュアル整備

#### Phase 9: 営業・マーケティング
- 他店舗への営業活動
- デモ環境の整備

---

## 8. 現状の素地

既に2店舗のDB設定が存在する:
```php
$db_config = [
    'houman' => [...],
    'rakuen' => [...]
];
```
→ これを発展させれば比較的スムーズに移行可能

---

## 9. 次のアクション

1. **まずは AWS Lightsail から始める**
2. **設定の外部化（Phase 1）から着手**
3. **セキュリティ設定は一緒に進める**

---

## 10. 注意事項

### クラウド移行時の注意
| 項目 | Xserver（現在） | クラウド/VPS |
|------|---------|-------------|
| サーバー管理 | 不要（お任せ） | **自分で行う** |
| セキュリティ更新 | 自動 | **自分で行う** |
| バックアップ | 自動 | **自分で設定** |
| メール機能 | 付属 | **別途設定が必要** |
| SSL証明書 | 無料で自動 | **自分で設定** |

→ **セキュリティ設定などはCursorと一緒に進める予定**

---

## 11. スーパー管理画面構想

### 2層の管理画面構造

```
┌─────────────────────────────────────────────────────────┐
│           🔑 スーパー管理画面（オーナー専用）            │
│  ┌─────────────────────────────────────────────────┐   │
│  │  ・新店舗の追加/削除                            │   │
│  │  ・ドメイン設定                                 │   │
│  │  ・DB作成/接続情報管理                          │   │
│  │  ・管理者アカウント発行                         │   │
│  │  ・SEOキーワード設定                            │   │
│  │  ・機能のON/OFF                                 │   │
│  │  ・全店舗の売上/アクセス一覧                    │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                          ↓ 店舗を作成
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│ 🏪 店舗A管理 │ │ 🏪 店舗B管理 │ │ 🏪 店舗C管理 │
│  ・デザイン  │ │  ・デザイン  │ │  ・デザイン  │
│  ・キャスト  │ │  ・キャスト  │ │  ・キャスト  │
│  ・スケジュール│ │  ・スケジュール│ │  ・スケジュール│
│  ・ブログ    │ │  ・ブログ    │ │  ・ブログ    │
└──────────────┘ └──────────────┘ └──────────────┘
```

### スーパー管理画面で設定できる項目

#### 基本設定
| 項目 | 説明 |
|------|------|
| 店舗名 | 「豊満倶楽部」「人妻の楽園」など |
| ドメイン | club-houman.com |
| DB名 | 自動生成 or 手動指定 |
| ステータス | 有効/無効/メンテナンス中 |

#### 管理者アカウント
| 項目 | 説明 |
|------|------|
| 管理者ID | 店舗用ログインID |
| PASSWORD | 初期パスワード発行 |
| メールアドレス | 通知用 |

#### SEO設定
| 項目 | 説明 |
|------|------|
| サイトタイトル | `<title>`タグ用 |
| ディスクリプション | meta description |
| キーワード | 地域名、業種など |
| OGP画像 | SNSシェア用 |

#### 店舗情報
| 項目 | 説明 |
|------|------|
| 電話番号 | 複数対応（受付/求人など） |
| 営業時間 | 開店〜閉店 |
| 対応エリア | 出張可能地域 |
| LINE ID | 連携用 |

#### 機能ON/OFF
| 機能 | 説明 |
|------|------|
| メンバー機能 | ポイント、ログイン |
| ブログ機能 | キャストブログ |
| 予約機能 | Web予約 |
| スクレイピング | シティヘブン連携 |
| LINE連携 | 通知機能 |
| 求人ページ | 求人フォーム |

### メリット
| メリット | 説明 |
|---------|------|
| 新店舗追加が超簡単 | 管理画面でポチポチするだけ。コードを触る必要なし |
| 営業ツールになる | 「こんな簡単にお店作れますよ」とデモできる |
| 権限分離 | オーナー＝全権限、店舗管理者＝自店舗のみ |
| カスタマイズの自由度 | 店舗ごとに使う機能を選べる |
| 一元管理 | 全店舗の状況を1画面で把握 |
| スケーラブル | 100店舗でも同じ仕組みで対応可能 |

---

## 12. SaaS化について

### SaaS化とDocker化の違い

| | SaaS化 | Docker化 |
|---|--------|----------|
| **これは何？** | **ビジネスモデル**（提供形態） | **技術**（実装方法） |
| **質問** | 「何を売るか？」 | 「どうやって動かすか？」 |
| **目的** | 他社にサービスとして提供 | 環境を統一・効率化 |

### 関係性
```
SaaS化（目標）
    │
    ├── Docker化（技術手段の1つ）
    │
    ├── マルチテナント（設計パターン）
    │
    ├── スーパー管理画面（運用ツール）
    │
    └── 課金システム（ビジネス基盤）
```

**Docker化はSaaS化を実現するための「道具」の1つ**

### SaaS化に必要なもの

| 要素 | 説明 | 現在の状況 |
|------|------|-----------|
| マルチテナント | 1つのシステムで複数店舗 | 構想中 |
| Docker化 | 環境の統一・スケール | 構想中 |
| スーパー管理画面 | 店舗追加・管理 | 構想中 |
| 課金システム | 月額料金の徴収 | 未検討 |
| サポート体制 | 問い合わせ対応 | 未検討 |
| 利用規約・契約 | 法的な整備 | 未検討 |
| セキュリティ | 他社データの保護 | 要強化 |

### SaaS化のビジネスモデル例

| プラン | 月額 | 内容 |
|--------|------|------|
| ライト | 3万円 | 基本機能のみ |
| スタンダード | 5万円 | 予約機能、メンバー機能 |
| プレミアム | 10万円 | 全機能 + 優先サポート |

※ 価格は仮。デリヘル業界のHP制作相場は初期50〜100万円 + 月額管理費が一般的

---

## 13. Docker化の障害復旧メリット

### 従来のサーバー vs Docker の比較

#### 従来のサーバー（現在のXserverなど）
```
サイトが動かなくなった！
    ↓
何が原因？
    ↓
├── PHPのエラー？ → ログを調査
├── DBが止まった？ → MySQLを確認
├── メモリ不足？ → サーバー状態を確認
├── ファイル破損？ → どのファイル？
└── 設定ファイルが壊れた？ → どの設定？
    ↓
原因を特定して個別に対処
    ↓
⏱️ 数時間〜数日かかることも
```

#### Docker化した場合
```
サイトが動かなくなった！
    ↓
コンテナを再起動
    ↓
docker restart houman-container
    ↓
✅ 復旧完了（数秒〜数分）
```

### なぜ簡単なのか

| 特徴 | 説明 |
|------|------|
| 使い捨て可能 | コンテナは「設計図（イメージ）」から何度でも作り直せる |
| 環境が固定 | PHP、MySQL、設定すべてが「箱」の中にセットされている |
| 独立している | 他のシステムに影響されない |

### 障害復旧の比較

| | 従来サーバー | Docker | Docker + Kubernetes |
|---|-------------|--------|---------------------|
| 障害発生時 | 原因調査が必要 | 再起動で解決 | 自動で復旧 |
| 復旧時間 | 数時間〜 | 数秒〜数分 | ほぼゼロ |
| 人手 | 必要 | 少し必要 | 不要 |

### 過去の事故との関連
Docker化していれば：
- **コード/設定** → コンテナ再作成で復旧
- **DB** → 別で管理しているので影響なし

→ **DBを巻き込まずに復旧できた可能性が高い**

---

## 14. SEO観点での分析

### マルチテナントとSEOの関係

#### 問題ない点
| 項目 | 説明 |
|------|------|
| 独立ドメイン | 各店舗が別ドメインなので、Googleは別々のサイトとして認識 |
| コンテンツの独自性 | DBが店舗ごとに分離されているので、キャスト情報・ブログは完全に独立 |
| サイト速度向上 | クラウド移行でパフォーマンスが上がれば、SEOにプラス（Core Web Vitals） |

#### 注意が必要な点
| 項目 | リスク | 対策 |
|------|--------|------|
| IP共有 | 同じサーバーIPを複数サイトが共有 | 共有サーバーも同様なので実質問題なし。気になるならCloudflare等でIP分散 |
| テンプレート構造の類似 | HTML構造が同じになりがち | コンテンツが異なれば問題なし。デザイン・色は店舗ごとに変える |
| サイトマップ/robots.txt | 各ドメインごとに適切な設定が必要 | マルチテナント実装時に自動生成する仕組みを入れる |
| 店舗間の相互リンク | 過度なクロスリンクはペナルティリスク | 必要最小限に抑える、またはnofollow付与 |

### デリヘル業界のSEO特性

| 流入経路 | 重要度 |
|---------|--------|
| シティヘブン等のポータルサイト | ★★★★★ 最重要 |
| 店舗名での直接検索 | ★★★★☆ |
| 「地域名 + デリヘル」等の一般検索 | ★★★☆☆ |
| オーガニックSEO（ブログ等） | ★★☆☆☆ |

→ **ポータルサイトからの流入が主流**なので、マルチテナント化がSEOに致命的な影響を与える可能性は低い

### マルチテナント実装時のSEO対策チェックリスト
- [ ] 各ドメインごとに独自のtitle/meta description
- [ ] 各ドメインごとにサイトマップ自動生成
- [ ] 各ドメインごとにrobots.txt設定
- [ ] 構造化データ（JSON-LD）を店舗情報に合わせて動的生成
- [ ] canonicalタグの適切な設定
- [ ] 店舗ごとにデザイン・配色を差別化
- [ ] Google Search Consoleを各ドメインで登録

---

## 15. メール送信の現状と移行

### 現在のメール送信一覧

| カテゴリ | 用途 | 送信先 | 送信元アドレス |
|---------|------|--------|---------------|
| **予約関連** | ネット予約通知（管理者向け） | nasu.o.0327@gmail.com | yoyaku@club-houman.com |
| | ネット予約確認（お客様向け） | お客様のメール | yoyaku@club-houman.com |
| **会員関連** | 会員登録確認メール | 会員のメール | noreply@club-houman.com |
| | 会員パスワード再送 | 会員のメール | notification@club-houman.com |
| **キャスト関連** | キャスト登録確認メール | キャストのメール | noreply@club-houman.com |
| | キャストパスワード再送 | キャストのメール | notification@club-houman.com |
| **トーク通知** | 運営⇔キャスト/会員のトーク | 各メール | notification@club-houman.com |
| **システム** | スクレイピングエラー通知 | 管理者メール | system@ドメイン |

### 月間メール通数と移行コスト

| 項目 | 数値 |
|------|------|
| 推定月間通数 | 約700通 |
| AWS SESコスト | **約10円/月**（$0.10/1,000通） |

### 使用しているFromアドレス（整理推奨）
- notification@club-houman.com
- noreply@club-houman.com
- yoyaku@club-houman.com
- system@ドメイン

→ 移行時に2つ程度に整理するとスッキリ

### 移行時の作業
1. AWS SESのセットアップ
2. SPF/DKIM設定（DNSレコード追加）
3. サンドボックス解除申請（1〜2日）
4. PHPコードの修正（`mail()` → SES SDK or SMTP経由）

---

## 16. GAS連携とLINE通知

### 現在の仕組み
```
メール受信（複数ソース）
      ↓
Gmail（nasu.o.0327@gmail.com）
      ↓
GAS（1分間隔でチェック）
      ↓
LINE Messaging API（Push送信）
```

### GASで監視している送信元
- yoyaku@cityheaven.net（シティヘブン予約）
- info@e-yoyaku.jp（e予約）
- info@purelovers.com（ピュアラバーズ）
- yoyaku@club-houman.com（自社ネット予約）
- yoyaku@club-1914.jp（別店舗）

### AWS移行後の影響
| 項目 | 影響 |
|------|------|
| メールアドレス | **変更不要**（同じアドレスを使用可能） |
| Gmail受信 | **そのまま** |
| GAS | **設定変更不要** |
| LINE転送 | **そのまま動作** |

### 重要ポイント
- AWS SESでも同じドメインのメールアドレスを使用可能
- GASの設定変更は一切不要
- LINE webhook連携もそのまま動作

### 将来の選択肢（AWSで完結させる場合）
```
AWS SESでメール受信 → S3保存 → Lambda起動 → LINE API呼び出し
```
メリット: リアルタイム性向上（1分間隔→即時）
デメリット: 構築が必要
→ 現状はGASで十分。将来的に検討可能。

---

## 17. プラットフォームドメイン構想

### 概要
マルチテナント用のプラットフォームドメインを取得し、サブドメインでテスト環境を構築。
完成後に本番ドメインのDNSを切り替えて移行する方式。

### 構成例
```
【プラットフォームドメイン】例: houman-system.com
    │
    ├── admin.houman-system.com      ← スーパー管理画面
    │
    ├── houman.houman-system.com     ← 豊満倶楽部（テスト）
    │
    ├── rakuen.houman-system.com     ← 人妻の楽園（テスト）
    │
    └── demo.houman-system.com       ← 営業用デモ環境

【本番ドメイン】
    club-houman.com → AWSのIPを指すようDNS変更で本番移行
```

### この方式のメリット
| メリット | 説明 |
|---------|------|
| 本番に影響ゼロ | 完成するまで旧サーバーで稼働し続ける |
| じっくりテスト | 納得いくまでテスト環境で確認できる |
| SaaS化に最適 | プラットフォームとしての基盤ができる |
| スーパー管理画面 | admin.xxx.com でアクセスできる |
| 新店舗テスト | いつでもサブドメインでテスト可能 |
| ブランディング | システム名を付けられる |

### ドメイン名の候補
- houman-system.com
- houman-platform.com
- fuzoku-cms.com
- deli-portal.com
※ 取得可能かは要確認

### 本番移行の流れ
```
Step 1: プラットフォームドメイン取得（約1,500円/年）
Step 2: AWS Lightsailにデプロイ
Step 3: プラットフォームのDNS設定（*.xxx.com → AWS IP）
Step 4: テスト環境で開発・確認
Step 5: 完成確認・全機能テスト
Step 6: 本番ドメインのDNS切り替え
Step 7: 本番稼働開始
```

### 追加コスト
| 項目 | 費用 |
|------|------|
| プラットフォームドメイン | 約1,500円/年 |
| ワイルドカードSSL（Let's Encrypt） | 無料 |

---

## 18. ワイルドカードSSL

### 通常のSSL vs ワイルドカードSSL

| | 通常SSL | ワイルドカードSSL |
|---|---------|------------------|
| カバー範囲 | 1ドメインのみ | 全サブドメイン |
| 証明書の数 | サブドメイン数分必要 | 1つだけ |
| 管理の手間 | 多い | 少ない |
| Let's Encrypt | 無料 | 無料 |
| 更新作業 | 複数回 | 1回 |

### ワイルドカードSSLの仕組み
```
*.houman-system.com のワイルドカードSSL証明書1つで：

├── admin.houman-system.com   🔒 HTTPS対応
├── houman.houman-system.com  🔒 HTTPS対応
├── rakuen.houman-system.com  🔒 HTTPS対応
└── 新店舗.houman-system.com  🔒 自動でHTTPS対応！
```

### マルチテナントに最適な理由
- 新店舗を追加してもSSL証明書の作業は不要
- サブドメインが増えても証明書は1つのまま
- Let's Encryptで無料取得可能（DNS認証が必要）

---

## 19. 移行時のダウンタイム対策

### ダウンタイムとは
サーバー切り替え時にサイトが利用できない時間のこと。

### ダウンタイムを最小化する方法

#### 推奨：並行運用方式
```
1. 新サーバー（AWS）を構築
2. テスト用ドメイン/サブドメインで動作確認
3. 本番データを新サーバーにコピー
4. DNS切り替え（深夜の閑散時間帯）
5. 旧サーバーはしばらく維持（緊急時の保険）
```
→ **ダウンタイム: ほぼゼロ〜数分**

### 推奨する切り替え時間帯
| 時間帯 | アクセス傾向 |
|--------|-------------|
| 深夜2〜6時 | 最も少ない ← 推奨 |
| 10〜14時 | 普通 |
| 18〜24時 | 最も多い |

### テスト方法
| 方法 | 説明 | 用途 |
|------|------|------|
| IPアドレスでアクセス | http://54.123.45.67/ | 基本動作確認 |
| hostsファイル編集 | 自分のPCだけ新サーバーを見る | 本番URL確認 |
| テスト用サブドメイン | test.xxx.com → AWS | 誰でもテスト可能 |
| ローカルDocker | localhost:8080 | 開発中のテスト |

---

---

## 20. MVP定義（pullcass v1.0）

### ゴール
**マルチテナントシステムが動作し、豊満倶楽部のHPが表示される状態**

### 完了条件
- [ ] 3画面が動作する（スーパー管理画面・店舗管理画面・フロントページ）
- [ ] 豊満倶楽部を管理画面から登録できる
- [ ] 現在のHPと同等の見た目で表示される
- [ ] houman.pullcass.com でアクセス可能
- [ ] SSL対応（Let's Encrypt）
- [ ] 基本的なセキュリティ設定

### MVP必須の3画面

#### スーパー管理画面（admin.pullcass.com）
| 機能 | MVP | 説明 |
|------|:---:|------|
| 店舗新規登録 | ✅ | 店舗名・ドメイン・DB作成 |
| 店舗一覧 | ✅ | 登録済み店舗の確認 |
| 店舗ON/OFF | ✅ | 公開/非公開の切り替え |
| 店舗削除 | ⬜ | v1.1以降 |
| 売上/アクセス一覧 | ⬜ | v1.1以降 |

#### 店舗管理画面
| 機能 | MVP | 説明 |
|------|:---:|------|
| 基本設定 | ✅ | 店舗情報・ロゴ・画像 |
| キャスト管理 | ✅ | 登録・編集・削除 |
| スケジュール管理 | ✅ | 出勤情報 |
| 料金管理 | ✅ | コース・価格 |
| テーマ管理 | ✅ | カラー・フォント変更（現行システムを参考） |
| お知らせ投稿 | ⬜ | v1.1以降 |
| ブログ機能 | ⬜ | v1.1以降 |
| メンバー管理 | ⬜ | v2.0以降 |
| 予約管理 | ⬜ | v2.0以降 |
| スクレイピング連携 | ⬜ | v2.0以降 |

#### フロントページ
| ページ | MVP | 説明 |
|--------|:---:|------|
| トップページ | ✅ | 店舗の顔 |
| キャスト一覧 | ✅ | 在籍キャスト |
| キャスト詳細 | ✅ | プロフィール・写真 |
| スケジュール | ✅ | 出勤情報 |
| 料金表 | ✅ | コース・価格 |
| 店舗情報 | ✅ | 電話・営業時間等 |
| お知らせ一覧 | ⬜ | v1.1以降 |
| ブログ | ⬜ | v1.1以降 |
| 会員ログイン | ⬜ | v2.0以降 |
| 予約フォーム | ⬜ | v2.0以降 |

---

## 21. データ入力方針

| データ種別 | 入力方法 |
|-----------|---------|
| キャスト基本情報 | スクレイピング（シティヘブン等） |
| スケジュール | 管理画面から手入力 |
| 料金 | 管理画面から手入力 |
| 店舗情報 | スーパー管理画面から入力 |
| テーマ設定 | 店舗管理画面から入力 |

**重要**: 直接DBに入れ込まない（検証にならないため）

---

## 22. 開発方針

### アプローチ
- 現在の豊満倶楽部HP（public_html）を**参考**にして新規構築
- 同じ機能を実装する際は該当ファイルを参照
- マルチテナント対応を最初から組み込む

### ディレクトリ構成
```
Desktop/
├── club-houman-v2/
│   └── public_html/          ← 現在の豊満倶楽部（参照用）
│
└── pullcass/                  ← 新プロジェクト
    ├── public_html/           ← 新規開発
    ├── docker/                ← Docker設定
    └── docs/                  ← 仕様書
```

### 参照ファイル一覧（現行システム）
| 機能 | 参照先 |
|------|--------|
| テーマ管理 | admin/theme_manage/, includes/theme_helper.php |
| キャスト管理 | admin/cast_manage/ |
| スケジュール | schedule/ |
| 料金管理 | admin/price_manage/ |
| トップページ | top.php, top_mobile.php |
| キャスト一覧・詳細 | cast/list.php, cast/detail.php |
| DB接続 | includes/db_connect.php, config/databases.php |
| 認証 | includes/admin_auth.php |
| メンバー機能 | member/member_admin/ |
| ブログ | blog/, admin/blog_manage/ |

---

## 23. バージョンロードマップ

### v1.0（MVP）
- マルチテナント基盤
- 3画面（スーパー管理・店舗管理・フロント）
- 豊満倶楽部1店舗が動作
- houman.pullcass.com でアクセス可能

### v1.1（系列店追加）
- 人妻の楽園を追加（rakuen.pullcass.com）
- 豊満熟女クラブを追加（jukujo.pullcass.com）
- 3店舗での安定稼働確認
- お知らせ/ブログ機能

### v2.0（本番移行）
- 本番ドメイン切り替え（club-houman.com）
- メンバー機能
- 予約機能
- スクレイピング連携
- LINE連携

### v3.0（SaaS化）
- 課金システム（Stripe等）
- 利用規約・契約書
- 外部店舗の受付開始
- サポート体制整備

---

## 24. 懸念点と対策

### 技術的な懸念点
| 懸念 | 対策 |
|------|------|
| Docker万能論の誤解 | 再起動で解決しない障害もあることを認識 |
| 単一コンテナの全体影響 | 初期は問題なし、10店舗超で見直し |
| DB分離の運用負荷 | 自動化を前提に設計 |
| テナント分離（論理分離） | コードレビュー必須、WHERE条件漏れに注意 |

### ビジネス的な懸念点
| 懸念 | 対策 |
|------|------|
| スーパー管理画面の開発コスト | MVP段階では最小限の機能に絞る |
| SaaS化による責任範囲拡大 | 課金開始前にSLA・利用規約を整備 |
| Kubernetes移行タイミング | 100店舗規模になるまで考えない |

---

## 25. データベース設計方針（2026/1/13決定）

### 採用方式: 共有DB + tenant_id

**店舗ごとに別DBではなく、1つのDBで全店舗を管理する方式を採用。**

### 検討した2つの方式

| 方式 | メリット | デメリット |
|-----|---------|-----------|
| **① 店舗ごとに別DB** | データ完全分離、セキュリティ高 | DB管理が煩雑、テーブル変更時に全店舗更新必要 |
| **② 共有DB + tenant_id** | 管理が楽、スキーマ変更が一度で済む | クエリに必ずtenant_id条件が必要 |

### 共有DB方式を選んだ理由

1. **500店舗目標に対応**
   - 500個の別DBを管理するのは現実的に不可能
   - テーブル変更時に500個のDBにALTER TABLEは非効率

2. **運用効率**
   - 新規店舗登録が完全自動（手作業不要）
   - テーブル追加・変更が1回で完了
   - バックアップ管理が容易

3. **パフォーマンス**
   - 適切なインデックス（tenant_id含む）があれば別DB方式と同等の速度
   - 500店舗規模でも問題なし

4. **実績**
   - Shopify、Salesforce、Slackなど大手SaaSが採用
   - 将来的なシャーディングへの移行も可能

### テーブル構成

```
【プラットフォーム管理】
├── super_admins          # マスター管理者
├── tenants               # 店舗基本情報
├── tenant_features       # 店舗別機能ON/OFF
├── tenant_admins         # 店舗管理者ログイン
└── tenant_settings       # 店舗詳細設定（SEO、デザイン等）

【店舗データ（tenant_id付き）】※今後実装
├── casts                 # キャスト情報
├── cast_schedules        # スケジュール
├── members               # 会員
├── reviews               # 口コミ
├── diary_posts           # 写メ日記
├── themes                # テーマ設定
└── ...
```

### セキュリティ対策

| リスク | 対策 |
|-------|------|
| SQLインジェクションで全店舗漏洩 | プリペアドステートメント徹底 |
| tenant_id付け忘れ | 基底クラスで自動付与、コードレビュー |
| 開発者のミス | テスト、監査ログ |

### インデックス設計（重要）

全てのtenant_id付きテーブルで、検索条件に使うカラムとtenant_idを組み合わせたインデックスを作成:

```sql
-- 例: castsテーブル
CREATE INDEX idx_tenant_active ON casts(tenant_id, is_active);
CREATE INDEX idx_tenant_schedule ON cast_schedules(tenant_id, schedule_date);
```

---

## 備考
- この件は別チャットで続きを話す予定
- Cursorがサポートできる内容: セキュリティ設定、SSL、PHP設定、MySQL設定、バックアップ、監視、デプロイなど
- **更新日: 2026年1月3日** - SEO観点、スーパー管理画面構想、SaaS化について追記
- **更新日: 2026年1月11日** - MVP定義、データ入力方針、開発方針、バージョンロードマップ、懸念点と対策を追記
- **更新日: 2026年1月13日** - DB設計方針（共有DB + tenant_id方式）を決定・追記

