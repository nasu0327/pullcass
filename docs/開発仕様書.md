# pullcass（プルキャス）開発仕様書

**最終更新: 2026年1月17日**

> **🔔 重要**: この仕様書は、別チャットで作業を引き継ぐ際の情報源です。  
> 仕様変更があった場合は、必ずこのファイルを更新してください。

---

## 📑 目次

1. [プロジェクト概要](#1-プロジェクト概要)
2. [システムアーキテクチャ](#2-システムアーキテクチャ)
3. [マルチテナント実装](#3-マルチテナント実装)
4. [テーマシステム](#4-テーマシステム)
5. [ディレクトリ構造](#5-ディレクトリ構造)
6. [データベース設計](#6-データベース設計)
7. [開発フロー](#7-開発フロー)
8. [デプロイメント](#8-デプロイメント)
9. [重要な設計思想](#9-重要な設計思想)
10. [コーディング規約](#10-コーディング規約)
11. [トラブルシューティング](#11-トラブルシューティング)
12. [ロードマップ](#12-ロードマップ)

---

## 1. プロジェクト概要

### 1.1 プロジェクトの目標

**デリヘル業界向けマルチテナント型SaaSプラットフォームの構築**

現在運営中の豊満倶楽部（club-houman.com）を**参考**に、最終的に**500店舗規模**に対応できる新しいシステムをゼロから構築する。

### 1.2 基本情報

| 項目 | 内容 |
|------|------|
| **サービス名** | pullcass（プルキャス） |
| **ドメイン** | pullcass.com（AWS Route 53で取得） |
| **参考サイト** | club-houman.com（豊満倶楽部） |
| **サーバー** | AWS Lightsail（IP: 18.181.114.195） |
| **技術スタック** | PHP 8.2, MySQL 8.0, nginx |
| **デプロイ** | GitHub自動デプロイ（push時に本番反映） |
| **開発環境** | 本番環境で直接開発・確認 |

### 1.3 登録店舗（現在）

| 店舗名 | コード | ステータス |
|--------|--------|-----------|
| 豊満倶楽部 | houman-club | 稼働中 |
| 豊満熟女クラブ | houman-jyukujyo | 稼働中 |

### 1.4 構築アプローチ

**❌ 従来の移行アプローチ（採用しない）**
```
現在の豊満倶楽部コード → マルチテナント化改修 → AWS移行
```

**✅ 新規構築アプローチ（採用）**
```
Step 1: 新しいマルチテナントWebアプリをAWSにゼロから構築
         （現在の豊満倶楽部を「参考」にする）
Step 2: スーパー管理画面から「豊満倶楽部」アカウントを作成
Step 3: 豊満倶楽部用の店舗管理画面でデザイン・機能を設定
Step 4: club-houman.comのDNSを切り替えて公開
```

**メリット:**
- 技術的負債なし
- 最初からマルチテナント設計
- きれいなコード
- テスト環境で完成させられる
- 他店舗展開が簡単

---

## 2. システムアーキテクチャ

### 2.1 全体構成

```
┌─────────────────────────────────────────────────────────┐
│                  pullcass.com（プラットフォーム）        │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌───────────────────────────────────────────────┐     │
│  │   スーパー管理画面 (/admin/)                  │     │
│  │   - 新店舗追加・削除                          │     │
│  │   - 全店舗一元管理                            │     │
│  │   - オーナー専用                              │     │
│  └───────────────────────────────────────────────┘     │
│                         ↓                                │
│  ┌───────────┬───────────┬───────────┐                │
│  │ 店舗A     │ 店舗B     │ 店舗C     │                │
│  ├───────────┼───────────┼───────────┤                │
│  │ 管理画面  │ 管理画面  │ 管理画面  │                │
│  │ フロント  │ フロント  │ フロント  │                │
│  └───────────┴───────────┴───────────┘                │
│                         ↓                                │
│  ┌─────────────────────────────────────────────┐       │
│  │        共有DB（tenant_id で論理分離）       │       │
│  └─────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────┘
```

### 2.2 3層構造の管理画面

```
┌─────────────────────────────────────┐
│  🔑 スーパー管理画面                 │
│  (/admin/)                          │
│  - 新店舗追加・削除                  │
│  - 全店舗一元管理                    │
│  - オーナー専用                      │
│  ログイン: admin / password         │
└─────────────────────────────────────┘
             ↓
┌─────────────────────────────────────┐
│  🏪 店舗管理画面                     │
│  (/app/manage/?tenant=xxx)          │
│  - キャスト管理                      │
│  - スケジュール管理                  │
│  - 料金管理                          │
│  - テーマ設定                        │
│  - 各店舗の管理者がログイン          │
└─────────────────────────────────────┘
             ↓
┌─────────────────────────────────────┐
│  🌐 フロントページ                   │
│  (houman.pullcass.com)              │
│  - トップページ                      │
│  - キャスト一覧・詳細                │
│  - スケジュール                      │
│  - 料金表                            │
│  - 一般ユーザー向け                  │
└─────────────────────────────────────┘
```

### 2.3 技術スタック

| レイヤー | 技術 |
|---------|------|
| **Webサーバー** | nginx |
| **アプリケーション** | PHP 8.2-fpm |
| **データベース** | MySQL 8.0 |
| **インフラ** | AWS Lightsail |
| **DNS** | AWS Route 53 |
| **デプロイ** | GitHub自動デプロイ |
| **開発環境** | 本番環境（AWS Lightsail） |

---

## 3. マルチテナント実装

### 3.1 テナント判別方法

テナントの判別は以下の優先順位で行われます：

```php
// www/includes/tenant.php

1. サブドメイン判別
   例: houman.pullcass.com → テナントコード "houman-club"

2. カスタムドメイン判別（今後実装予定）
   例: club-houman.com → テナントコード "houman-club"

3. URLパラメータ判別（開発・管理画面用）
   例: /app/manage/?tenant=houman-club
```

### 3.2 テナント情報の取得

```php
// テナント情報を取得
$tenant = getCurrentTenant($pdo);

// 取得できる情報
$tenant['id']              // テナントID
$tenant['tenant_code']     // テナントコード（例: houman-club）
$tenant['tenant_name']     // 店舗名（例: 豊満倶楽部）
$tenant['domain']          // ドメイン（例: houman.pullcass.com）
$tenant['phone']           // 電話番号
$tenant['logo_url']        // ロゴURL
$tenant['ga4_id']          // Google Analytics 4 ID
// ... その他の設定
```

### 3.3 重要な設計思想

**❗ 絶対にハードコードしない**

- 店舗名、ロゴ、電話番号、SEO設定、構造化データなど、テナント固有の情報は必ずテナント情報から動的に取得する
- 特定のテナント（豊満倶楽部など）に依存しない汎用的な実装を心がける
- 新機能や修正を行う際は、必ず全テナントで動作することを確認する

**例（良い実装）:**
```php
// ✅ 良い例：動的に取得
echo '<title>' . h($tenant['tenant_name']) . '</title>';
```

**例（悪い実装）:**
```php
// ❌ 悪い例：ハードコード
echo '<title>豊満倶楽部</title>';
```

---

## 4. テーマシステム

### 4.1 テーマシステムの仕組み

pullcassのテーマシステムは、**共通CSS + CSS変数**で構成されています。

```
┌─────────────────────────────────────────────────────┐
│  www/assets/css/style.css（共通スタイル）           │
│  - HTML構造、レイアウト、基本スタイルを定義         │
│  - CSS変数（--color-primary, --font-title1等）使用 │
└─────────────────────────────────────────────────────┘
              ↓ CSS変数の値を動的に変更
┌─────────────────────────────────────────────────────┐
│  テーマ管理画面（/app/manage/theme_edit.php）       │
│  - カラー設定（プライマリ、セカンダリ等）          │
│  - フォント設定（タイトル1、タイトル2、本文）      │
│  - 背景設定（単色、グラデーション、画像）          │
└─────────────────────────────────────────────────────┘
              ↓ theme_helper.php で CSS変数生成
┌─────────────────────────────────────────────────────┐
│  :root {                                            │
│    --color-primary: #F568DF;                        │
│    --color-secondary: #FFA0F8;                      │
│    --font-title1: 'Kranky', 'Kaisei Decol';        │
│    /* ... */                                        │
│  }                                                  │
└─────────────────────────────────────────────────────┘
```

### 4.2 CSS変数の定義

```css
/* www/assets/css/style.css */

:root {
    /* カラー・フォントはテーマシステムで動的に生成 */
    /* --color-primary, --color-secondary, --color-text, 
       --color-btn-text, --color-bg, --color-overlay, 
       --font-title1, --font-title2, --font-body */
    
    /* 背景グラデーション */
    --color-bg-gradient: linear-gradient(90deg, #ffffff 0%, #ffd2fe 100%);
    
    /* スペーシング */
    --spacing-xs: 5px;
    --spacing-sm: 10px;
    --spacing-md: 15px;
    --spacing-lg: 20px;
    --spacing-xl: 35px;
    
    /* ボーダー */
    --border-radius-sm: 8px;
    --border-radius-md: 12px;
    --border-radius-lg: 15px;
    --border-radius-full: 9999px;
    
    /* レイアウト */
    --container-max-width: 1200px;
    
    /* シャドウ */
    --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
    --shadow-md: 0 2px 8px rgba(0,0,0,0.07);
    --shadow-lg: 0 4px 8px rgba(0,0,0,0.1);
}
```

### 4.3 参考サイトとの関係

```
┌─────────────────────────────────────────────────────┐
│  reference/public_html/（参考サイトのコード）       │
│  - 豊満倶楽部（club-houman.com）の実際のコード     │
│  - HTML構造、CSS、機能の参考として使用             │
└─────────────────────────────────────────────────────┘
              ↓ 参考にして実装
┌─────────────────────────────────────────────────────┐
│  www/assets/css/style.css（pullcass用CSS）          │
│  - 参考サイトのデザインを再現                       │
│  - テーマシステムで色・フォントをカスタマイズ可能  │
└─────────────────────────────────────────────────────┘
```

**重要なルール:**

1. **必ず最初にHTML構造・CSS・クラス名・サイズを詳細に確認してから実装する**
2. 「だいたい」ではなく「完全一致」を目指す
3. 参考サイトのコードを忠実に再現する
4. デザイン修正が二度手間三度手間にならないよう、最初から正確に実装する

### 4.4 テーマ管理画面で設定できる項目

| カテゴリ | 設定項目 | CSS変数 |
|---------|---------|---------|
| **カラー** | プライマリカラー | `--color-primary` |
| | セカンダリカラー | `--color-secondary` |
| | テキストカラー | `--color-text` |
| | ボタンテキストカラー | `--color-btn-text` |
| | オーバーレイ色 | `--color-overlay` |
| **フォント** | タイトル1 | `--font-title1` |
| | タイトル2 | `--font-title2` |
| | 本文 | `--font-body` |
| **背景** | 背景タイプ | 単色/グラデーション/画像 |
| | 開始色 | グラデーション用 |
| | 終了色 | グラデーション用 |

---

## 5. ディレクトリ構造

### 5.1 全体構成

```
pullcass/
├── docs/                             # ドキュメント
│   ├── 開発仕様書.md                 # 本ドキュメント（最重要）
│   └── クラウド移行_マルチテナント構想.md  # 初期構想ドキュメント
│
├── migrations/                       # DBマイグレーションSQL
│   ├── add_theme_tables.sql
│   ├── add_cast_scraping_tables.sql
│   └── ...
│
├── reference/                        # 参考サイトのコード
│   └── public_html/                  # 豊満倶楽部の実際のコード
│       ├── top.php                   # トップページ
│       ├── cast/                     # キャスト関連
│       ├── admin/                    # 管理画面
│       ├── assets/css/style.css      # 参考サイトのCSS
│       └── ...
│
├── www/                              # アプリケーション本体
│   ├── admin/                        # スーパー管理画面
│   │   ├── index.php                 # ダッシュボード
│   │   ├── login.php                 # ログイン
│   │   ├── settings.php              # システム設定
│   │   └── tenants/                  # 店舗管理
│   │       ├── index.php             # 店舗一覧
│   │       ├── create.php            # 店舗新規登録
│   │       ├── edit.php              # 店舗編集
│   │       └── delete.php            # 店舗削除
│   │
│   ├── app/
│   │   ├── front/                    # フロントページ（テナント別）
│   │   │   ├── index.php             # トップページ
│   │   │   ├── cast_list.php         # キャスト一覧
│   │   │   ├── cast_detail.php       # キャスト詳細
│   │   │   ├── schedule.php          # スケジュール
│   │   │   └── ...
│   │   │
│   │   └── manage/                   # 店舗管理画面（テナント別）
│   │       ├── index.php             # ダッシュボード
│   │       ├── settings.php          # 基本設定
│   │       ├── cast_list.php         # キャスト一覧
│   │       ├── cast_form.php         # キャスト登録・編集
│   │       ├── schedule_list.php     # スケジュール一覧
│   │       ├── price_list.php        # 料金一覧
│   │       ├── theme_list.php        # テーマ一覧
│   │       ├── theme_edit.php        # テーマ編集
│   │       └── ...
│   │
│   ├── assets/                       # 静的ファイル
│   │   ├── css/
│   │   │   ├── style.css             # 共通スタイル（最重要）
│   │   │   ├── admin.css             # 管理画面用
│   │   │   └── manage.css            # 店舗管理画面用
│   │   ├── js/
│   │   │   └── main.js
│   │   └── img/
│   │       └── logo.svg
│   │
│   ├── includes/                     # 共通機能
│   │   ├── bootstrap.php             # アプリケーション初期化
│   │   ├── config.php                # 設定
│   │   ├── database.php              # DB接続
│   │   ├── functions.php             # 共通関数
│   │   ├── tenant.php                # テナント判別・取得
│   │   └── theme_helper.php          # テーマCSS生成
│   │
│   ├── uploads/                      # アップロードファイル
│   │   └── tenants/
│   │       ├── houman-club/
│   │       │   ├── logo/
│   │       │   ├── casts/
│   │       │   └── ...
│   │       └── houman-jyukujyo/
│   │
│   └── index.php                     # プラットフォームトップ
│
└── README.md                         # プロジェクト概要
```

**注意: docker/ディレクトリは参考用**

- ローカル開発環境用のDocker設定ファイルが含まれているが、実際の開発では使用しない
- 本番環境（AWS Lightsail）で直接開発・確認を行う

### 5.2 重要なファイル

| ファイル | 役割 |
|---------|------|
| `www/includes/bootstrap.php` | アプリケーション初期化（最初に読み込む） |
| `www/includes/tenant.php` | テナント判別・取得 |
| `www/includes/theme_helper.php` | テーマCSS生成 |
| `www/assets/css/style.css` | 共通スタイルシート（最重要） |
| `reference/public_html/assets/css/style.css` | 参考サイトのCSS |
| `docs/開発仕様書.md` | 本ドキュメント（仕様変更時に更新） |

---

## 6. データベース設計

### 6.1 DB設計方針（2026/1/13決定）

**採用方式: 共有DB + tenant_id**

店舗ごとに別DBではなく、**1つのDBで全店舗を管理**する方式を採用。

**理由:**
- 500店舗目標に対応（500個の別DBを管理するのは非現実的）
- テーブル変更時に全店舗更新が不要（1回のALTER TABLEで完了）
- 新規店舗登録が完全自動化
- バックアップ管理が容易

### 6.2 テーブル構成

#### プラットフォーム管理テーブル（tenant_idなし）

| テーブル名 | 説明 |
|-----------|------|
| `super_admins` | マスター管理者 |
| `tenants` | 店舗基本情報 |
| `tenant_admins` | 店舗管理者ログイン |

#### 店舗データテーブル（tenant_id付き）

| テーブル名 | 説明 |
|-----------|------|
| `themes` | テーマ設定 |
| `casts` | キャスト情報（今後実装） |
| `cast_schedules` | スケジュール（今後実装） |
| `members` | 会員（今後実装） |
| `reviews` | 口コミ（今後実装） |
| `diary_posts` | 写メ日記（今後実装） |

### 6.3 重要: tenant_idの扱い

**全てのクエリで必ず tenant_id 条件を付ける**

```php
// ✅ 良い例
$stmt = $pdo->prepare("
    SELECT * FROM casts 
    WHERE tenant_id = ? AND is_active = 1
");
$stmt->execute([$tenant['id']]);

// ❌ 悪い例（tenant_id条件なし → 全店舗のデータが取得される）
$stmt = $pdo->prepare("
    SELECT * FROM casts 
    WHERE is_active = 1
");
```

### 6.4 インデックス設計

全てのtenant_id付きテーブルで、検索条件に使うカラムとtenant_idを組み合わせたインデックスを作成:

```sql
-- 例: castsテーブル
CREATE INDEX idx_tenant_active ON casts(tenant_id, is_active);
CREATE INDEX idx_tenant_schedule ON cast_schedules(tenant_id, schedule_date);
```

### 6.5 データベース操作の注意事項

**重要: SQLはphpMyAdminから実行する**

- データベース操作（マイグレーション、SQLの実行等）は、AIが直接実行しない
- 必ずSQLコードと実行手順を提供し、ユーザーがphpMyAdminから実行する
- 理由: 安全性、トラブル時の追跡容易性、本番環境での慎重な操作

**手順:**
```
1. AIがSQLコードと実行手順を提供
2. ユーザーがphpMyAdminにアクセス
3. ユーザーが該当のデータベースを選択
4. ユーザーがSQLタブでコードを実行
5. 実行結果を確認
```

---

## 7. 開発フロー

### 7.1 基本フロー

```
1. 新機能の要件確認
   ↓
2. 参考サイト（reference/）を確認
   - HTML構造、CSS、クラス名、サイズを詳細に確認
   - 「だいたい」ではなく「完全一致」を目指す
   ↓
3. DB変更が必要な場合
   - AIがSQLコードと実行手順を提供
   - ユーザーがphpMyAdminから実行
   ↓
4. 実装（本番環境で直接編集）
   - テナント固有情報はハードコードしない
   - CSS変数を使用してテーマシステムに対応
   ↓
5. 本番環境でテスト
   - ブラウザで https://pullcass.com にアクセス
   - 複数テナントで動作確認
   - レスポンシブ対応確認
   ↓
6. SSH操作が必要な場合
   - AIがコマンドと実行手順を提供
   - ユーザーがAWS管理画面からSSHで実行
   ↓
7. 自動コミット＆プッシュ（AIが実行）
   - git add .
   - git commit -m "日本語のコミットメッセージ"
   - git push origin main
   - 本番サーバーに自動デプロイ
```

**重要: 本番環境で直接開発**

- ローカル環境は使用しない
- AWS Lightsail上で直接ファイルを編集・確認
- DB操作はユーザーがphpMyAdminから実行
- SSH操作はユーザーがAWS管理画面から実行

### 7.2 参考サイトの確認手順

**重要: ユーザーが「参考サイトを確認して下さい」と言った場合**

必ず以下の両方を確認すること：

#### 1. ブラウザで直接確認
```
- URL: https://club-houman.com/
- ブラウザツールを使用して参考サイトにアクセス
- DevToolsで要素を検証
  - HTML構造
  - クラス名
  - CSS（padding, margin, font-size等）
  - 色コード
  - レスポンシブ動作
- 実際の動作を確認
```

#### 2. reference/ディレクトリ内のファイルを確認
```
- reference/public_html/ の該当ファイルを確認
  - PHPコード
  - assets/css/style.css のスタイル
  - JavaScriptコード
  - HTML構造
- コードの実装方法を詳細に確認
```

**確認の流れ:**
```
1. ブラウザで参考サイト（club-houman.com）にアクセス
   ↓ 見た目・動作を確認
2. DevToolsで要素を検証
   ↓ HTML構造・CSS・クラス名を確認
3. reference/public_html/ の該当ファイルを読む
   ↓ PHPコード・CSS実装を確認
4. 完全一致を目指して実装
```

**なぜ両方必要か:**

- **ブラウザ確認**: 実際の見た目、動作、レスポンシブ動作を確認
- **ファイル確認**: コードの実装方法、ロジック、詳細な設定を確認
- **両方を組み合わせる**: 完全一致の実装が可能になる

**なぜ重要か:**

- 適当に作ると機能面のミス（ソート順など）に気づきにくい
- デザイン修正が二度手間三度手間になる
- 開発者・依頼者双方が混乱する

### 7.3 DB操作の手順

**新しいテーブル追加やカラム追加が必要な場合:**

AIは以下の形式でSQLコードと手順を提供します：

```sql
-- ============================================
-- テーブル追加: キャスト情報テーブル
-- ============================================

CREATE TABLE IF NOT EXISTS casts (
    id INT AUTO_INCREMENT PRIMARY KEY,
    tenant_id INT NOT NULL,
    name VARCHAR(100) NOT NULL,
    age INT,
    is_active TINYINT(1) DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_tenant_active (tenant_id, is_active),
    FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- 実行手順:
-- 1. phpMyAdminにアクセス
-- 2. データベース「pullcass」を選択
-- 3. 「SQL」タブをクリック
-- 4. 上記のSQLをコピー＆ペースト
-- 5. 「実行」ボタンをクリック
-- 6. 成功メッセージを確認
-- ============================================
```

**カラム追加の例:**

```sql
-- ============================================
-- カラム追加: tenantsテーブルにロゴURLカラムを追加
-- ============================================

ALTER TABLE tenants 
ADD COLUMN logo_url VARCHAR(255) DEFAULT NULL AFTER tenant_name;

-- ============================================
-- 実行手順:
-- 1. phpMyAdminにアクセス
-- 2. データベース「pullcass」を選択
-- 3. 「SQL」タブをクリック
-- 4. 上記のSQLをコピー＆ペースト
-- 5. 「実行」ボタンをクリック
-- 6. 成功メッセージを確認
-- 7. tenantsテーブルの構造を確認してカラムが追加されていることを確認
-- ============================================
```

### 7.4 SSH操作の手順

**SSH操作が必要な場合:**

AIは以下の形式でコマンドと手順を提供します：

```bash
# ============================================
# ファイルのパーミッション変更
# ============================================

# コマンド
chmod 755 /path/to/directory
chmod 644 /path/to/file.php

# ============================================
# 実行手順:
# 1. AWSコンソールにログイン
# 2. Lightsailダッシュボードを開く
# 3. インスタンスの「接続」をクリック
# 4. ブラウザベースのSSH接続を開く
# 5. 上記のコマンドを実行
# 6. 実行結果を確認
# ============================================
```

### 7.5 新機能実装チェックリスト

- [ ] **参考サイトをブラウザで確認した**（https://club-houman.com/）
- [ ] **reference/ディレクトリ内の該当ファイルを確認した**
- [ ] DevToolsでHTML構造・CSS・クラス名を確認した
- [ ] DB変更が必要な場合、SQLコードと手順を提供した
- [ ] テナント固有情報をハードコードしていない
- [ ] CSS変数を使用している
- [ ] 複数テナントで動作確認した
- [ ] レスポンシブ対応を確認した
- [ ] Font Awesomeアイコンを使用している（絵文字は使用しない）
- [ ] セキュリティ対策（XSS、CSRF等）を実装した
- [ ] エラーハンドリングを実装した

### 7.6 Git操作（自動プッシュ）

**重要: AIが修正を行った場合、自動的にGitHubにプッシュする**

通常の修正指示や追加指示でAIがコードを修正した場合：

```bash
# 1. 変更をステージング
git add .

# 2. コミット（日本語メッセージ）
git commit -m "キャスト一覧ページのレイアウト修正

- グリッド表示を2カラムから3カラムに変更
- カードのシャドウを調整
- レスポンシブ対応を改善"

# 3. プッシュ（required_permissions: ['all'] を使用）
git push origin main
```

**重要: プッシュ時は必ず `required_permissions: ['all']` を指定すること**

理由：
- `git_write` と `network` だけではSSL証明書エラーが発生する
- `required_permissions: ['all']` でサンドボックスを完全に解除する必要がある
- エラー例: `fatal: unable to access 'https://github.com/...': error setting certificate verify locations`

**コミットメッセージの形式:**
- タイトル（1行目）と本文（2行目以降）の両方を日本語で記述
- 何を変更したか、なぜ変更したかを明確に記述

**プッシュのタイミング:**
- コード修正が完了した時点で自動的にプッシュ
- 複数ファイルを修正した場合は、まとめて1つのコミットでプッシュ
- DB操作やSSH操作のコード提供だけの場合はプッシュ不要（ユーザーが実行後にプッシュ）

---

## 7.7 AI（Cursor）の役割と制限

### AIが行うこと ✅

1. **参考サイトの確認**
   - ユーザーが「参考サイトを確認して下さい」と言った場合
   - **ブラウザで直接確認**（https://club-houman.com/）
   - **reference/ディレクトリ内のファイルを確認**
   - DevToolsで要素を検証
   - 両方を組み合わせて完全一致を目指す

2. **コードの提案・実装**
   - PHP、HTML、CSS、JavaScriptの実装
   - ファイルの作成・編集
   - バグ修正

3. **Git操作（自動）**
   - コード修正後の自動コミット
   - GitHubへの自動プッシュ
   - 日本語でのコミットメッセージ作成

4. **SQLコードの提供**
   - CREATE TABLE文の作成
   - ALTER TABLE文の作成
   - INSERT/UPDATE/DELETE文の作成
   - **実行手順の明記**
   - ※ユーザーがphpMyAdminから実行

5. **SSHコマンドの提供**
   - パーミッション変更コマンド
   - ファイル操作コマンド
   - **実行手順の明記**
   - ※ユーザーがAWS管理画面から実行

6. **ドキュメントの作成・更新**
   - 仕様書の更新
   - コメントの追加
   - 更新後は自動プッシュ

### AIが行わないこと ❌

1. **DB操作の直接実行**
   - SQL文の直接実行は行わない
   - 必ずユーザーがphpMyAdminから実行

2. **SSH操作の直接実行**
   - SSHコマンドの直接実行は行わない
   - 必ずユーザーがAWS管理画面から実行

3. **本番環境への直接アクセス**
   - データベースへの直接接続は行わない
   - サーバーへの直接接続は行わない

### 理由

- **安全性**: 本番環境での誤操作を防ぐ
- **トレーサビリティ**: ユーザーが実行履歴を把握できる
- **確認プロセス**: ユーザーがコードを確認してから実行できる

---

## 8. デプロイメント

### 8.1 デプロイフロー

```
本番環境（AWS Lightsail）で直接編集
   ↓ 動作確認
本番環境（AWS Lightsail）で git commit
   ↓ git push
GitHub（リポジトリ）に反映
   ↓ 自動デプロイ
AWS Lightsail（本番サーバー）に反映
```

**重要: GitHubにプッシュすると本番サーバーに自動デプロイされる**

- ユーザーに手動での `git pull` 指示は不要
- 本番環境で直接編集・確認してからプッシュする
- ローカル環境は使用しない

### 8.2 Git操作の注意事項

**自動プッシュのルール:**
- コード修正を行った場合は、自動的に `git add`, `git commit`, `git push` を実行
- Gitコミットメッセージは日本語で記述
- Gitのプッシュ時は**常に `required_permissions: ['all']` を使用**（サンドボックス完全解除）
  - `git_write` と `network` だけでは不十分（SSL証明書エラーが発生）
  - `['all']` を指定してサンドボックスを完全に解除する必要がある

**禁止事項:**
- NEVER run destructive/irreversible git commands（force push等）
- NEVER skip hooks（--no-verify等）
- NEVER force push to main/master

**プッシュ不要なケース:**
- SQLコードの提供のみ（ユーザーが実行後にプッシュ）
- SSHコマンドの提供のみ（ユーザーが実行後にプッシュ）

### 8.3 本番サーバー情報

| 項目 | 内容 |
|------|------|
| **サービス** | AWS Lightsail |
| **プラン** | Lightsail（詳細はAWSコンソールで確認） |
| **IPアドレス** | 18.181.114.195 |
| **DNS** | AWS Route 53 |
| **ドメイン** | pullcass.com（Route 53で取得） |
| **URL** | https://pullcass.com |
| **phpMyAdmin** | 本番サーバー上でアクセス可能 |

### 8.4 開発環境

**本番環境で直接開発**

- ローカル環境は使用しない
- AWS Lightsail上で直接ファイルを編集
- ブラウザで https://pullcass.com にアクセスして確認
- phpMyAdminでDB操作を行う
- GitHubにプッシュして自動デプロイ

---

## 9. 重要な設計思想

### 9.1 マルチテナント対応の原則

1. **テナント固有情報は必ず動的に取得**
   - 店舗名、ロゴ、電話番号、営業時間、SEO設定、構造化データ（Schema.org / JSON-LD）等
   - ハードコードは厳禁

2. **汎用的な実装を心がける**
   - 特定のテナント（豊満倶楽部など）に依存しない
   - 新店舗を追加しても動作する

3. **tenant_id条件を必ず付ける**
   - 全てのSQLクエリでtenant_id条件を付ける
   - セキュリティ上非常に重要

### 9.2 テーマシステムの原則

1. **CSS変数を活用**
   - 色、フォント等、テナントごとに変更する値はCSS変数で定義
   - style.cssは共通スタイルのみ

2. **参考サイトを忠実に再現**
   - HTML構造、CSS、クラス名を完全一致させる
   - 「だいたい」ではなく「完全一致」を目指す

3. **レスポンシブ対応**
   - スマホ、タブレット、PCで確認
   - 参考サイトのレスポンシブ動作を忠実に再現

### 9.3 セキュリティの原則

1. **プリペアドステートメント徹底**
   - SQLインジェクション対策

2. **XSS対策**
   - 出力時は必ず `h()` 関数でエスケープ

3. **CSRF対策**
   - フォームには必ずCSRFトークンを付与

4. **認証・認可**
   - セッション管理を適切に行う
   - 権限チェックを徹底

### 9.4 コーディングの原則

1. **Font Awesomeアイコンを使用**
   - 絵文字（emoji）は使用しない
   - 全ページで統一

2. **日本語コメント**
   - コードにはわかりやすい日本語コメントを付ける

3. **エラーハンドリング**
   - try-catch、if文でエラーを適切に処理
   - ユーザーフレンドリーなエラーメッセージ

---

## 10. コーディング規約

### 10.1 PHP

```php
<?php
/**
 * ファイルの説明
 */

// 名前空間（今後導入予定）
// namespace Pullcass\App\Front;

// 共通ファイルの読み込み
require_once __DIR__ . '/../../includes/bootstrap.php';

// 認証チェック（必要に応じて）
// requireLogin();

// テナント情報取得
$tenant = getCurrentTenant($pdo);
if (!$tenant) {
    // エラー処理
    exit('店舗が見つかりません');
}

// メイン処理
try {
    // データベースクエリ（必ずtenant_id条件を付ける）
    $stmt = $pdo->prepare("
        SELECT * FROM casts 
        WHERE tenant_id = ? AND is_active = 1
        ORDER BY sort_order ASC
    ");
    $stmt->execute([$tenant['id']]);
    $casts = $stmt->fetchAll();
} catch (PDOException $e) {
    // エラーハンドリング
    error_log($e->getMessage());
    exit('データの取得に失敗しました');
}

// HTML出力
?>
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title><?= h($tenant['tenant_name']) ?></title>
</head>
<body>
    <h1><?= h($tenant['tenant_name']) ?></h1>
    
    <?php foreach ($casts as $cast): ?>
        <div class="cast-card">
            <h2><?= h($cast['name']) ?></h2>
        </div>
    <?php endforeach; ?>
</body>
</html>
```

### 10.2 SQL

```sql
-- tenant_id条件を必ず付ける
SELECT * FROM casts 
WHERE tenant_id = ? AND is_active = 1
ORDER BY sort_order ASC;

-- インデックスを適切に設定
CREATE INDEX idx_tenant_active ON casts(tenant_id, is_active);
```

### 10.3 CSS

```css
/* CSS変数を使用 */
.button-primary {
    background-color: var(--color-primary);
    color: var(--color-btn-text);
    border-radius: var(--border-radius-md);
    padding: var(--spacing-sm) var(--spacing-lg);
}

/* レスポンシブ対応 */
@media (max-width: 768px) {
    .container {
        padding: var(--spacing-sm);
    }
}
```

### 10.4 HTML

```html
<!-- Font Awesomeアイコンを使用 -->
<i class="fas fa-heart"></i>

<!-- 絵文字は使用しない -->
<!-- ❌ ❤️ -->

<!-- XSS対策: 必ずエスケープ -->
<p><?= h($tenant['tenant_name']) ?></p>

<!-- CSRFトークン -->
<form method="POST">
    <input type="hidden" name="csrf_token" value="<?= h(generateCsrfToken()) ?>">
    <!-- ... -->
</form>
```

---

## 11. トラブルシューティング

### 11.1 よくある問題と解決方法

| 問題 | 原因 | 解決方法 |
|------|------|---------|
| テナントが見つからない | テナントコードが正しくない | `tenants`テーブルを確認 |
| CSS変数が反映されない | テーマが公開されていない | テーマ管理画面で「公開」に設定 |
| 全店舗のデータが表示される | tenant_id条件がない | SQLに`WHERE tenant_id = ?`を追加 |
| ログインできない | セッションが切れている | ログイン画面に戻ってログイン |
| デプロイされない | GitHubにプッシュしていない | `git push`を実行 |

### 11.2 デバッグ方法

```php
// デバッグ出力（開発環境のみ）
if (APP_DEBUG) {
    echo '<pre>';
    var_dump($tenant);
    echo '</pre>';
}

// またはdd()関数を使用
dd($tenant);

// エラーログ
error_log('エラー: ' . $e->getMessage());
```

### 11.3 よくある実装ミス

1. **tenant_id条件の付け忘れ**
   ```php
   // ❌ 悪い例
   $stmt = $pdo->query("SELECT * FROM casts");
   
   // ✅ 良い例
   $stmt = $pdo->prepare("SELECT * FROM casts WHERE tenant_id = ?");
   $stmt->execute([$tenant['id']]);
   ```

2. **HTMLエスケープの忘れ**
   ```php
   // ❌ 悪い例（XSS脆弱性）
   echo $tenant['tenant_name'];
   
   // ✅ 良い例
   echo h($tenant['tenant_name']);
   ```

3. **ハードコード**
   ```php
   // ❌ 悪い例
   echo '<title>豊満倶楽部</title>';
   
   // ✅ 良い例
   echo '<title>' . h($tenant['tenant_name']) . '</title>';
   ```

---

## 12. ロードマップ

### 12.1 v1.0（MVP）✅ 完了

- [x] マルチテナント基盤
- [x] スーパー管理画面（店舗登録・一覧・ON/OFF）
- [x] 店舗管理画面（基本設定・テーマ）
- [x] フロントページ（トップページ）
- [x] テーマシステム

### 12.2 v1.1（機能追加）🔄 進行中

- [ ] キャスト管理機能
- [ ] スケジュール管理機能
- [ ] 料金管理機能
- [ ] キャスト一覧・詳細ページ
- [ ] スケジュールページ
- [ ] 料金表ページ

### 12.3 v2.0（本番移行準備）

- [ ] お知らせ/ブログ機能
- [ ] メンバー機能
- [ ] 予約機能
- [ ] スクレイピング連携
- [ ] LINE連携
- [ ] 本番ドメイン切り替え（club-houman.com）

### 12.4 v3.0（SaaS化）

- [ ] 課金システム（Stripe等）
- [ ] 利用規約・契約書
- [ ] 外部店舗の受付開始
- [ ] サポート体制整備

---

## 💡 今後追加すべき内容

別チャットで作業を開始する際に、さらに役立つ可能性がある内容を提案します：

### 優先度：高 🔴

#### 1. 本番環境アクセス手順
- AWS Lightsailへのアクセス方法
  - AWSコンソールへのログイン方法
  - SSHキーの管理
  - SSH接続コマンド
  - phpMyAdminへのアクセス方法
  - ファイル編集方法（vim、nano等のエディタ使用）
  - Git操作方法（commit、push等）

#### 2. 外部サービス連携
- LINE Messaging API
  - Webhook設定
  - トークン管理
- Google Analytics 4（GA4）
  - 測定ID設定
  - イベントトラッキング
- AWS Route 53
  - DNSレコード設定
  - サブドメイン追加方法

### 優先度：中 🟡

#### 3. バックアップ・リストア手順
- DBバックアップの方法
- ファイルバックアップの方法
- リストア手順
- 定期バックアップの設定

#### 4. テスト方法
- ブラウザテストのチェックリスト
- 複数テナントでのテスト方法
- レスポンシブテスト

### 優先度：低 🟢

#### 5. API仕様書（今後実装予定）
#### 6. パフォーマンス最適化（最適化が必要になったら）

これらの内容が必要になった際は、別ファイルとして作成するか、この仕様書に追記してください。

---

## 📝 更新履歴

| 日付 | 内容 |
|------|------|
| 2026/1/17 | 初版作成。既存ドキュメントと開発状況を統合した包括的な仕様書 |
| 2026/1/17 | 開発環境を修正。ローカル環境は使用せず、本番環境で直接開発・確認 |
| 2026/1/17 | DB操作・SSH操作の手順を追加。AIはコードと手順を提供、ユーザーが実行 |
| 2026/1/17 | Git自動プッシュのルールを追加。コード修正後はAIが自動的にプッシュ |
| 2026/1/17 | 参考サイト確認手順を明確化。ブラウザ確認とreference/ファイル確認の両方を実施 |

---

## 🔔 仕様変更時の更新について

**このファイルは、pullcassプロジェクトの「単一情報源（Single Source of Truth）」です。**

仕様変更があった場合は、必ずこのファイルを更新してください：

1. 新機能の追加
2. テーブル構造の変更
3. ディレクトリ構造の変更
4. 開発フローの変更
5. 重要な設計決定
6. トラブルシューティングの追加

**更新方法:**
```bash
# ファイルを編集
vim docs/開発仕様書.md

# コミット
git add docs/開発仕様書.md
git commit -m "開発仕様書を更新: [変更内容]"

# プッシュ
git push
```

---

## 📚 関連ドキュメント

- [クラウド移行_マルチテナント構想.md](./クラウド移行_マルチテナント構想.md) - 初期構想ドキュメント
- [README.md](../README.md) - プロジェクト概要

---

**以上が、pullcass（プルキャス）の開発仕様書です。**

別チャットで作業を引き継ぐ際は、このドキュメントを参照してください。  
不明な点があれば、このドキュメントを更新して共有知識にしてください。
